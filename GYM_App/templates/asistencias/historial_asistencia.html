{% extends "base.html" %}

{% block styles %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
    /* Estilos adicionales para un aspecto m치s elegante */
    .module-header h2 {
        font-weight: 300;
        letter-spacing: 1px;
    }
    .filter-card {
        border: none;
        border-left: 5px solid #007bff;
        border-radius: .5rem;
        box-shadow: 0 4px 6px rgba(0,0,0,.1);
    }
    .table-responsive {
        background-color: #fff;
        border-radius: .5rem;
        box-shadow: 0 4px 6px rgba(0,0,0,.1);
        padding: 1rem;
    }
    .form-control, .form-select {
        border-radius: .25rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="module-header d-flex justify-content-between align-items-center mb-4">
        <h2 class="module-title">游늶 Historial de Asistencias</h2>
    </div>

    <div class="card filter-card mb-4">
        <div class="card-body">
            <h5 class="card-title">Filtros de B칰squeda</h5>
            <div class="row g-3">
                <div class="col-md-6">
                    <label for="search-input" class="form-label">Buscar por Nombre</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" class="form-control" id="search-input" placeholder="Escribe un nombre...">
                    </div>
                </div>
                <div class="col-md-3">
                    <label for="start_date" class="form-label">Fecha de Inicio</label>
                    <input type="date" class="form-control" id="start_date">
                </div>
                <div class="col-md-3">
                    <label for="end_date" class="form-label">Fecha de Fin</label>
                    <input type="date" class="form-control" id="end_date">
                </div>
            </div>
            <div class="mt-3">
                <button id="clear-filters-btn" class="btn btn-secondary btn-sm">
                    <i class="fas fa-redo me-2"></i>Limpiar Filtros
                </button>
            </div>
        </div>
    </div>
    
    <div class="table-responsive">
        <table class="table table-striped table-hover mb-0" id="asistencia-table">
            <thead class="table-dark">
                <tr>
                    <th>#</th>
                    <th>Cliente</th>
                    <th>Fecha y Hora</th>
                </tr>
            </thead>
            <tbody id="asistencia-table-body">
                </tbody>
        </table>
    </div>

    <div id="no-results" class="alert alert-info text-center mt-4 d-none">
        <i class="fas fa-info-circle me-2"></i> No se encontraron asistencias que coincidan con los filtros.
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Obtenemos todos los datos de asistencias iniciales y los guardamos
        let allAsistencias = [];

        // Elementos del DOM
        const searchInput = document.getElementById('search-input');
        const startDateInput = document.getElementById('start_date');
        const endDateInput = document.getElementById('end_date');
        const tableBody = document.getElementById('asistencia-table-body');
        const noResultsMessage = document.getElementById('no-results');
        const clearFiltersBtn = document.getElementById('clear-filters-btn');

        // Funci칩n para renderizar la tabla
        function renderTable(asistenciasToDisplay) {
            tableBody.innerHTML = '';
            if (asistenciasToDisplay.length === 0) {
                noResultsMessage.classList.remove('d-none');
            } else {
                noResultsMessage.classList.add('d-none');
                asistenciasToDisplay.forEach(asistencia => {
                    const row = `
                        <tr>
                            <td>${asistencia.id}</td>
                            <td>${asistencia.cliente_nombre}</td>
                            <td>${asistencia.fecha}</td>
                        </tr>
                    `;
                    tableBody.insertAdjacentHTML('beforeend', row);
                });
            }
        }

        // Funci칩n para aplicar filtros y renderizar la tabla
        function filterAndRender() {
            const searchTerm = searchInput.value.toLowerCase();
            const startDate = startDateInput.value ? new Date(startDateInput.value) : null;
            const endDate = endDateInput.value ? new Date(endDateInput.value) : null;

            const filteredAsistencias = allAsistencias.filter(asistencia => {
                // Filtro por nombre
                const matchesName = asistencia.cliente_nombre.toLowerCase().includes(searchTerm);
                
                // Filtro por fecha
                const asistenciaDate = new Date(asistencia.fecha.split(' ')[0]);
                const matchesDate = (!startDate || asistenciaDate >= startDate) && (!endDate || asistenciaDate <= endDate);

                return matchesName && matchesDate;
            });
            renderTable(filteredAsistencias);
        }

        // Eventos para la b칰squeda en tiempo real
        searchInput.addEventListener('input', filterAndRender);
        startDateInput.addEventListener('change', filterAndRender);
        endDateInput.addEventListener('change', filterAndRender);

        // Evento para limpiar filtros
        clearFiltersBtn.addEventListener('click', () => {
            searchInput.value = '';
            startDateInput.value = '';
            endDateInput.value = '';
            filterAndRender();
        });

        // Carga inicial de datos
        async function fetchAsistencias() {
            try {
                const response = await fetch('/asistencias/api/historial');
                if (!response.ok) {
                    throw new Error('Error al cargar datos de la API');
                }
                const data = await response.json();
                allAsistencias = data;
                renderTable(allAsistencias);
            } catch (error) {
                console.error("Error:", error);
                noResultsMessage.textContent = "Error al cargar los datos. Por favor, recargue la p치gina.";
                noResultsMessage.classList.remove('d-none');
            }
        }

        fetchAsistencias();
    });
</script>
{% endblock %}